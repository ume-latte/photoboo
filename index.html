<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Photoboo - 萬聖節拍貼機</title>
  <style>
    body {
      background: #2c2c2c; /* 萬聖節深色背景 */
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: Arial, sans-serif;
      color: #fff;
    }
    .container {
      background: #f7931a; /* 橘色外框 */
      padding: 20px;
      box-sizing: border-box;
      width: 720px;
      height: 1080px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5);
    }
    .panel {
      background: #fff;
      flex: 1;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      position: relative;
      overflow: hidden;
    }
    .panel img, .panel video, .panel canvas {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
    }
    .frame {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 10;
    }
    .sticker {
      position: absolute;
      cursor: move;
      z-index: 20;
      user-select: none;
    }
    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
    }
    button, select, input {
      padding: 10px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background: #ff6200;
      color: #fff;
      cursor: pointer;
    }
    button:hover, select:hover {
      background: #e55b00;
    }
    #download-strip {
      display: none;
      position: absolute;
      top: 0;
      left: 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="panel" id="panel1">
      <video id="video" autoplay></video>
      <canvas id="canvas1" style="display: none;"></canvas>
      <img class="frame" id="frame1" src="">
    </div>
    <div class="panel" id="panel2">
      <canvas id="canvas2" style="display: none;"></canvas>
      <img class="frame" id="frame2" src="">
    </div>
    <div class="panel" id="panel3">
      <canvas id="canvas3" style="display: none;"></canvas>
      <img class="frame" id="frame3" src="">
    </div>
  </div>
  <div class="controls">
    <select id="frame-selector">
      <option value="">選擇框架</option>
      <option value="frame1.png">萬聖節框架 1</option>
      <option value="frame2.png">萬聖節框架 2</option>
    </select>
    <button onclick="capturePhoto()">拍照</button>
    <input type="file" id="photo-upload" accept="image/*" style="display: none;">
    <button onclick="document.getElementById('photo-upload').click()">上傳照片</button>
    <button onclick="addRandomSticker()">隨機貼紙</button>
    <button onclick="downloadStrip()">下載照片條</button>
  </div>
  <canvas id="download-strip"></canvas>

  <script>
    const video = document.getElementById('video');
    const canvases = [
      document.getElementById('canvas1'),
      document.getElementById('canvas2'),
      document.getElementById('canvas3')
    ];
    const panels = [
      document.getElementById('panel1'),
      document.getElementById('panel2'),
      document.getElementById('panel3')
    ];
    const frames = [
      document.getElementById('frame1'),
      document.getElementById('frame2'),
      document.getElementById('frame3')
    ];
    const frameSelector = document.getElementById('frame-selector');
    const photoUpload = document.getElementById('photo-upload');
    let currentPhotoIndex = 0;

    // 啟動相機
    navigator.mediaDevices.getUserMedia({ video: true })
      .then(stream => {
        video.srcObject = stream;
      })
      .catch(err => console.error('相機啟動失敗:', err));

    // 選擇框架
    frameSelector.addEventListener('change', (e) => {
      frames.forEach(frame => {
        frame.src = e.target.value;
      });
    });

    // 拍照功能
    function capturePhoto() {
      if (currentPhotoIndex >= 3) return;
      const canvas = canvases[currentPhotoIndex];
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      canvas.style.display = 'block';
      if (currentPhotoIndex === 0) video.style.display = 'none';
      currentPhotoIndex++;
    }

    // 上傳照片
    photoUpload.addEventListener('change', (e) => {
      if (currentPhotoIndex >= 3) return;
      const file = e.target.files[0];
      const reader = new FileReader();
      reader.onload = () => {
        const img = new Image();
        img.onload = () => {
          const canvas = canvases[currentPhotoIndex];
          canvas.width = 720;
          canvas.height = 360;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, 720, 360);
          canvas.style.display = 'block';
          if (currentPhotoIndex === 0) video.style.display = 'none';
          currentPhotoIndex++;
        };
        img.src = reader.result;
      };
      reader.readAsDataURL(file);
    });

    // 隨機貼紙
    const stickers = [
      'pumpkin.png',
      'ghost.png',
      'witch_hat.png'
    ];
    function addRandomSticker() {
      const sticker = document.createElement('img');
      sticker.src = stickers[Math.floor(Math.random() * stickers.length)];
      sticker.className = 'sticker';
      sticker.style.width = '50px';
      sticker.style.left = `${Math.random() * (720 - 50)}px`;
      sticker.style.top = `${Math.random() * (360 - 50)}px`;
      panels[currentPhotoIndex - 1 || 0].appendChild(sticker);
      makeDraggable(sticker);
    }

    // 拖放功能
    function makeDraggable(element) {
      let posX = 0, posY = 0, mouseX = 0, mouseY = 0;
      element.onmousedown = startDragging;
      function startDragging(e) {
        e.preventDefault();
        mouseX = e.clientX;
        mouseY = e.clientY;
        document.onmousemove = dragElement;
        document.onmouseup = stopDragging;
      }
      function dragElement(e) {
        posX = mouseX - e.clientX;
        posY = mouseY - e.clientY;
        mouseX = e.clientX;
        mouseY = e.clientY;
        element.style.top = (element.offsetTop - posY) + 'px';
        element.style.left = (element.offsetLeft - posX) + 'px';
      }
      function stopDragging() {
        document.onmousemove = null;
        document.onmouseup = null;
      }
    }

    // 下載照片條
    function downloadStrip() {
      const downloadCanvas = document.getElementById('download-strip');
      downloadCanvas.width = 720;
      downloadCanvas.height = 1080;
      const ctx = downloadCanvas.getContext('2d');
      ctx.fillStyle = '#f7931a';
      ctx.fillRect(0, 0, 720, 1080);
      let yOffset = 20;
      canvases.forEach((canvas, index) => {
        ctx.drawImage(canvas, 20, yOffset, 680, 340);
        if (frames[index].src) {
          const frameImg = new Image();
          frameImg.src = frames[index].src;
          ctx.drawImage(frameImg, 20, yOffset, 680, 340);
        }
        panels[index].querySelectorAll('.sticker').forEach(sticker => {
          ctx.drawImage(sticker, parseInt(sticker.style.left) + 20, parseInt(sticker.style.top) + yOffset, 50, 50);
        });
        yOffset += 360;
      });
      const link = document.createElement('a');
      link.download = 'photoboo-strip.png';
      link.href = downloadCanvas.toDataURL();
      link.click();
    }
  </script>
</body>
</html>